{{/* 
  Hugo partial: Substack card with server-side RSS fetch
  Fetches and parses the latest Substack post at build time.
  No JavaScript â€” pure Hugo templating.
*/}}

{{ $feedURL := "https://murkyspaces.substack.com/feed" }}
{{ $fallbackImage := "/js/img.png" }}

{{ $res := resources.GetRemote $feedURL }}

{{ if $res }}
  {{ $content := $res.Content }}
  
  {{/* Find items/entries */}}
  {{ $items := findRE `(?s)<item>.*?</item>` $content }}
  {{ if not $items }}
    {{ $items = findRE `(?s)<entry>.*?</entry>` $content }}
  {{ end }}

  {{ if $items }}
    {{ $firstItem := index $items 0 }}
    
    {{/* Extract title with CDATA handling */}}
    {{ $title := replaceRE `(?s).*?<title>(.*?)</title>.*` "$1" $firstItem }}
    {{ $title = replaceRE `(?s)^\s*<!\[CDATA\[(.*)\]\]>\s*$` "$1" $title }}
    {{ $title = trim $title " \n\t\r" }}
    
    {{/* Extract link - try href attribute first, then link element */}}
    {{ $link := replaceRE `(?s).*?<link[^>]*href=["']([^"']+)["'][^>]*>.*` "$1" $firstItem }}
    {{ if eq $link $firstItem }}
      {{ $link = replaceRE `(?s).*?<link>(.*?)</link>.*` "$1" $firstItem }}
    {{ end }}
    
    {{/* Extract date - try pubDate first, then updated */}}
    {{ $pubDate := replaceRE `(?s).*?<pubDate>(.*?)</pubDate>.*` "$1" $firstItem }}
    {{ if eq $pubDate $firstItem }}
      {{ $pubDate = replaceRE `(?s).*?<updated>(.*?)</updated>.*` "$1" $firstItem }}
    {{ end }}
    
    {{/* Extract description with fallback to summary */}}
    {{ $desc := replaceRE `(?s).*?<description>(.*?)</description>.*` "$1" $firstItem }}
    {{ if eq $desc $firstItem }}
      {{ $desc = replaceRE `(?s).*?<summary>(.*?)</summary>.*` "$1" $firstItem }}
    {{ end }}
    {{ $desc = replaceRE `(?s)^\s*<!\[CDATA\[(.*)\]\]>\s*$` "$1" $desc }}
    {{ $desc = trim $desc " \n\t\r" }}
    {{ $desc = replaceRE `<[^>]+>` "" $desc }}
    {{ $desc = htmlUnescape $desc }}
    
    {{/* Extract image - try multiple sources */}}
    {{ $img := replaceRE `(?s).*?<enclosure[^>]+url=["']([^"']+)["'][^>]*>.*` "$1" $firstItem }}
    {{ if or (eq $img $firstItem) (not $img) }}
      {{ $img = replaceRE `(?s).*?<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["'][^>]*>.*` "$1" $firstItem }}
    {{ end }}
    {{ if or (eq $img $firstItem) (not $img) }}
      {{ $img = replaceRE `(?s).*?<img[^>]+src=["']([^"']+)["'][^>]*>.*` "$1" $firstItem }}
    {{ end }}

    {{/* Render successful card */}}
    <div class="card substack-card">
      <style>
        #substack-link { text-decoration: none !important; color: inherit; }
        #substack-link h2 { display: inline; margin: 0; font-size: 1.1rem; font-weight: 800; text-decoration: none; }
        #substack-link h2:hover, #substack-link h2:focus { text-decoration: underline; text-decoration-color: #c6a0e8; text-decoration-thickness: 3px; text-underline-offset: 3px; }
        #substack-title { margin-bottom: 0.9rem; display: inline-block; }
        .substack-hero { margin-top: 1.5rem; }
        .subscribe-inline { display: inline-flex; align-items: center; border: none; border-radius: 8px; padding: 4px; background: #c6a0e8; line-height:1; }
        .subscribe-inline .label { background: transparent; color: #fff; border: none; padding: 6px 10px; margin: 0; font-weight:700; font-size:13px; cursor: pointer; border-radius:6px; }
        .subscribe-inline input[type="email"] { border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; padding: 6px 8px; width: 150px; font-size: 13px; outline: none; background:#fff; color:#333; height:28px; margin-left:8px; }
      </style>

      <h4>Murky spaces</h4>
      <a id="substack-link" target="_blank" rel="noopener" href="{{ $link }}">
        <h2 id="substack-title">{{ $title }}</h2>
      </a>

      <div class="substack-hero" style="height:220px; overflow:hidden; position:relative;">
        {{ if $img }}
          <img id="substack-image" alt="Latest post image" src="{{ $img }}" style="width:100%;height:100%;object-fit:cover;" />
        {{ else }}
          <img id="substack-image" alt="Latest post image" src="{{ $fallbackImage }}" style="width:100%;height:100%;object-fit:cover;" />
        {{ end }}
      </div>

      <p id="substack-desc">{{ $desc }}</p>
      {{ with $pubDate }}
        <p id="substack-date">{{ . }}</p>
      {{ end }}
      <div style="margin-top:1rem;">
        <form action="https://murkyspaces.substack.com/subscribe" method="get" target="_blank" class="subscribe-inline" role="group" aria-label="Subscribe">
          <button class="label" type="submit">Subscribe</button>
          <input id="substack-email" name="email" type="email" placeholder="Your email" aria-label="Email" />
        </form>
      </div>
    </div>

  {{ else }}
    {{/* No items found in feed - use inline fallback */}}
    <div class="card substack-card">
      <style>
        #substack-link { text-decoration: none !important; color: inherit; }
        #substack-link h2 { display: inline; margin: 0; font-size: 1.1rem; font-weight: 800; text-decoration: none; }
        #substack-link h2:hover, #substack-link h2:focus { text-decoration: underline; text-decoration-color: #c6a0e8; text-decoration-thickness: 3px; text-underline-offset: 3px; }
        #substack-title { margin-bottom: 0.9rem; display: inline-block; }
        .substack-hero { margin-top: 1.5rem; }
        .subscribe-inline { display: inline-flex; align-items: center; border: none; border-radius: 8px; padding: 4px; background: #c6a0e8; line-height:1; }
        .subscribe-inline .label { background: transparent; color: #fff; border: none; padding: 6px 10px; margin: 0; font-weight:700; font-size:13px; cursor: pointer; border-radius:6px; }
        .subscribe-inline input[type="email"] { border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; padding: 6px 8px; width: 150px; font-size: 13px; outline: none; background:#fff; color:#333; height:28px; margin-left:8px; }
      </style>

      <h4>Murky spaces</h4>
      <a id="substack-link" target="_blank" rel="noopener" href="https://murkyspaces.substack.com">
        <h2 id="substack-title">Latest from Substack</h2>
      </a>

      <div class="substack-hero" style="height:220px; overflow:hidden; position:relative;">
        <img id="substack-image" alt="Latest post image" src="{{ $fallbackImage }}" style="width:100%;height:100%;object-fit:cover;" />
      </div>

      <p id="substack-desc">Subscribe to get the latest posts delivered to your inbox.</p>
      <div style="margin-top:1rem;">
        <form action="https://murkyspaces.substack.com/subscribe" method="get" target="_blank" class="subscribe-inline" role="group" aria-label="Subscribe">
          <button class="label" type="submit">Subscribe</button>
          <input id="substack-email" name="email" type="email" placeholder="Your email" aria-label="Email" />
        </form>
      </div>
    </div>
  {{ end }}

{{ else }}
  {{/* Feed fetch failed - use inline fallback */}}
  <div class="card substack-card">
    <style>
      #substack-link { text-decoration: none !important; color: inherit; }
      #substack-link h2 { display: inline; margin: 0; font-size: 1.1rem; font-weight: 800; text-decoration: none; }
      #substack-link h2:hover, #substack-link h2:focus { text-decoration: underline; text-decoration-color: #c6a0e8; text-decoration-thickness: 3px; text-underline-offset: 3px; }
      #substack-title { margin-bottom: 0.9rem; display: inline-block; }
      .substack-hero { margin-top: 1.5rem; }
      .subscribe-inline { display: inline-flex; align-items: center; border: none; border-radius: 8px; padding: 4px; background: #c6a0e8; line-height:1; }
      .subscribe-inline .label { background: transparent; color: #fff; border: none; padding: 6px 10px; margin: 0; font-weight:700; font-size:13px; cursor: pointer; border-radius:6px; }
      .subscribe-inline input[type="email"] { border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; padding: 6px 8px; width: 150px; font-size: 13px; outline: none; background:#fff; color:#333; height:28px; margin-left:8px; }
    </style>

    <h4>Murky spaces</h4>
    <a id="substack-link" target="_blank" rel="noopener" href="https://murkyspaces.substack.com">
      <h2 id="substack-title">Latest from Substack</h2>
    </a>

    <div class="substack-hero" style="height:220px; overflow:hidden; position:relative;">
      <img id="substack-image" alt="Latest post image" src="{{ $fallbackImage }}" style="width:100%;height:100%;object-fit:cover;" />
    </div>

    <p id="substack-desc">Subscribe to get the latest posts delivered to your inbox.</p>
    <div style="margin-top:1rem;">
      <form action="https://murkyspaces.substack.com/subscribe" method="get" target="_blank" class="subscribe-inline" role="group" aria-label="Subscribe">
        <button class="label" type="submit">Subscribe</button>
        <input id="substack-email" name="email" type="email" placeholder="Your email" aria-label="Email" />
      </form>
    </div>
  </div>
{{ end }}